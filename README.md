# 8 時間完結 PostgreSQL SQL 演習課題

## 目的
既存スキーマ（EC サイト 4 テーブル）を使い、**SQL の記述と理解**だけに集中して
以下を 1 日 (8h) で修得します。

* 基本 SELECT／JOIN／集約関数
* サブクエリ・WITH 句・集合演算
* ウィンドウ関数・分析関数
* 実行計画を読むきっかけ作り（任意）

---

## 前提スキーマ

| テーブル | 主なカラム | 備考 |
|----------|-----------|------|
| `users`        | `id` (PK), `name`, `created_at` |  |
| `products`     | `id` (PK), `name`, `price` | `price` は整数 (円) |
| `orders`       | `id` (PK), `user_id` (FK), `ordered_at` |  |
| `order_items`  | `order_id` (FK), `product_id` (FK), `quantity` |  |

サンプルデータは 1〜2 万件規模で配布済みです。テーブル定義や
データ投入スクリプトの変更は不要です。

---

## タイムテーブル（目安）

| 時間帯 | 内容 | 試験範囲 |
|--------|------|----------|
| 0:00‑0:30 | ウォームアップ | 基本 SELECT |
| 0:30‑2:00 | 基本〜中級 SQL  (5 問) | JOIN / GROUP BY |
| 2:00‑4:30 | 応用 SQL (5 問) | サブクエリ / WITH / 集合演算 |
| ― 昼休 ― |
| 4:30‑6:00 | ウィンドウ関数 (4 問) | RANK, SUM() OVER など |
| 6:00‑7:30 | 日付・CASE 応用 (4 問) | DATE_TRUNC, CASE |
| 7:30‑8:00 | 復習クイズ (択一 10 問) | 計画読み取り・ロック基礎 |

---

## 問題一覧（計 18 問）

| # | 難度 | トピック | 説明 |
|---|------|----------|------|
| 01 | ★ | SELECT | 価格降順で全商品の `id, name, price` を表示 |
| 02 | ★ | WHERE | 1,000 円未満の商品名と価格を昇順表示 |
| 03 | ★ | 集約 | 全注文数と合計売上額 |
| 04 | ★ | GROUP BY | ユーザ毎の注文回数 (降順) |
| 05 | ★★ | JOIN | 各注文 ID と合計個数 |
| 06 | ★★ | JOIN+GROUP | 商品別累計販売個数と売上 (Top10) |
| 07 | ★★ | サブクエリ | 平均価格より高い商品の一覧 |
| 08 | ★★ | EXISTS | 一度も注文されていない商品 |
| 09 | ★★ | IN/集合 | 「A さんが買ったが B さんが買っていない」商品 |
| 10 | ★★ | WITH | 月別売上サマリ → 直近 3 か月抽出 |
| 11 | ★★ | ウィンドウ | ユーザ別累計売上 & 順位 |
| 12 | ★★ | ウィンドウ | 注文内の商品ごとの数量割合 (%) |
| 13 | ★★★ | ウィンドウ | 商品別 7 日移動平均売上 |
| 14 | ★★★ | 日付関数 | 過去 30 日で注文が無い日 |
| 15 | ★★★ | CASE | 価格帯 (低/中/高) 別件数集計 |
| 16 | ★★★ | UNION | 2023 年と 2024 年の月別売上比較 |
| 17 | ★★★ | ROLLUP | `(product_id, month)` ROLLUP で小計/総計 |
| 18 | ★★★ | クイズ | 択一 10 問 (実行計画・隔離レベル基礎) |

★ = 易しい / ★★ = 標準 / ★★★ = やや難しい

---

## 提出方法

1. `queries.sql`  
   * 各問題を **コメントで番号を明記**して順番に記述  
   * 1 問につき 1 ステートメント
2. 自動採点  
   ```bash
   ./check.sh
   ```  
   合格ラインは **正答率 90% 以上**。不合格の場合は差分を確認して再提出してください。

---

## 自己学習・発展課題（任意）

* `EXPLAIN (ANALYZE, BUFFERS)` で 1 つ好きなクエリの実行計画を確認し、
  `Seq Scan` と `Index Scan` の違いを 3 行でまとめる  
* JSONB 列を追加し、タグ検索を `@>` 演算子で実装してみる  
* 図やブログなどで学習内容をアウトプット

---

## 参考資料

* SQLZOO — SELECT, JOIN, Aggregate 章  
* PostgreSQL 公式ドキュメント 7.2〜7.5  
* 書籍『達人に学ぶ SQL 実践入門』  

---

Happy Querying!  
