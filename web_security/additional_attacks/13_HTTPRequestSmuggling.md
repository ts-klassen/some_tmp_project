# HTTP Request Smuggling / HTTP Desync Attack

## 概要
フロントプロキシ (CDN, リバースプロキシ) とバックエンドサーバ間で **HTTP/1.1** のリクエスト長やメッセージ境界の解釈差を突き、複数リクエストを交差させる攻撃。別ユーザのリクエストを乗っ取ったり、キャッシュポイズニング・XSS へ連鎖する。

## 代表的な技法
1. **CL.TE**: フロントが `Content-Length`、バックエンドが `Transfer-Encoding: chunked` を優先。
2. **TE.CL**: 逆パターン。
3. HTTP/2 → HTTP/1 変換時のメッセージ分割差。

## 攻撃シナリオ
1. 攻撃者は 1 つの TCP 接続で特殊ヘッダを含むリクエスト A+B を送信。
2. プロキシは A だけをバックエンドへ転送し応答待ち状態となる。
3. 被害者の通常リクエストが続き、バックエンドでは A の残りと混ざって解釈される。
4. 被害者の Cookie が攻撃者に届く／XSS ペイロードが挿入される。

## 影響
・セッションハイジャック、認証バイパス  
・キャッシュ汚染、ミドルボックス崩壊  
・内部サーバポートスキャン

## 防御策
1. 最新のプロキシ／バックエンドにアップデートし、**HTTP/1.1 RFC 9112 準拠**させる。
2. `Content-Length` と `Transfer-Encoding` を同時に受け取ったら 400 で拒否。
3. HTTP/2→1 変換時にストリーム単位で分離し、新規接続へ切り分ける。
4. WAF / IDS で二重ヘッダ・不正チャンクを検出しブロック。

## 参考
・PortSwigger Research: HTTP Desync Attacks  
・CVE-2020-10713 等 各種実装バグ  
